<!DOCTYPE html>
<html lang="en">
  <head>
    <title>E-Receipt Parsing  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="E-Receipt Parsing  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">BlinkEReceipt extension SDK Docs</a></p>
        <p class="header-right"><a href="https://github.com/BlinkReceipt/blinkereceipt-ios"><img src="img/gh.png"/>View on GitHub</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">BlinkEReceipt extension SDK Reference</a>
        <img id="carat" src="img/carat.png" />
        E-Receipt Parsing  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Guides.html">Guides</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="e-receipt-parsing.html">E-Receipt Parsing</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/BRAmazonManager.html">BRAmazonManager</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/BREReceiptManager.html">BREReceiptManager</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Enums.html">Enumerations</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/BRAmazonError.html">BRAmazonError</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/BREReceiptIMAPError.html">BREReceiptIMAPError</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/BREReceiptProvider.html">BREReceiptProvider</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/BRGoogleAccountResult.html">BRGoogleAccountResult</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <h1 id='e-receipt-parsing' class='heading'>E-Receipt Parsing</h1>

<p>The BlinkReceipt SDK supports parsing e-receipts from a growing list of retailers and a specific set of mail providers: Gmail, Outlook, Yahoo, and AOL. The procedure for integrating each of these providers is slightly different. This guide will outline the steps necessary to integrate and authenticate a user account for each mail provider, and then the common methods that you will use to invoke the e-receipt parsing functionality.</p>
<h2 id='gmail' class='heading'>Gmail</h2>

<ul>
<li><p>Create a new Project in the <a href="https://console.developers.google.com">Google API Console</a></p></li>
<li><p>Enable the Gmail API for your project</p></li>
<li><p>Create new credentials for the API, and choose the iOS option. This should lead you through the process to create an OAuth 2.0 client ID. You will have to complete the setup of an OAuth Consent Screen.</p></li>
<li><p>Once you have successfully completed the process, find the Client ID for your app&rsquo;s bundle identifier</p></li>
</ul>

<p><img src="img/gmail.png" alt="Google API Console"></p>

<ul>
<li><p>Provide this Client ID via the <code><a href="Classes/BREReceiptManager.html#/c:objc(cs)BREReceiptManager(py)googleClientId">BREReceiptManager.googleClientId</a></code> property</p></li>
<li><p>Gmail uses OAuth to authenticate user accounts via a modal view controller provided by Google&rsquo;s SDK. Here is how you invoke it from within your own view controller:</p></li>
</ul>
<pre class="highlight objective_c"><code><span class="p">[[</span><span class="n">BREReceiptManager</span> <span class="nf">shared</span><span class="p">]</span> <span class="nf">beginOAuthForProvider</span><span class="p">:</span><span class="n">BREReceiptProviderGmail</span>
                               <span class="nf">withViewController</span><span class="p">:</span><span class="n">self</span>
                                    <span class="n">andCompletion</span><span class="o">:^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>

                                        <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
                                            <span class="c1">//Account successfully authenticated</span>
                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                            <span class="c1">//Failed to authenticate</span>
                                        <span class="p">}</span>
                                    <span class="p">}];</span>
</code></pre>

<ul>
<li>In order to handle the response from the OAuth process, you need to add the following to your app delegate:</li>
</ul>
<pre class="highlight plaintext"><code>#import &lt;GoogleSignIn/GoogleSignIn.h&gt;
...
- (BOOL)application:(UIApplication *)app
            openURL:(NSURL *)url
            options:(NSDictionary *)options
{
    return [[GIDSignIn sharedInstance] handleURL:url];
}
</code></pre>

<ul>
<li>Lastly, follow <a href="https://developers.google.com/identity/sign-in/ios/start-integrating#add_a_url_scheme_to_your_project">Google&rsquo;s instructions</a> to add the necessary URL scheme to your app</li>
</ul>
<h2 id='outlook' class='heading'>Outlook</h2>

<ul>
<li><p>Go to the <a href="https://portal.azure.com/">Azure Portal</a>, choose Manage Azure Active Directory, then App Registrations from the left menu, and click New Registration.</p></li>
<li><p>Enter a name for your app, choose the option to support accounts in any Azure AD directory as well as personal Microsoft accounts, and choose <q>Public client/native</q> for the Redirect URI type. Don&rsquo;t worry about the field value. Click Register.</p></li>
<li><p>This will generate an Application (client) ID which you should note for later.</p></li>
</ul>

<p><img src="img/outlook.png" alt="MS Portal"></p>

<ul>
<li><p>Now click <q>Add a Redirect URI</q> on the right side</p></li>
<li><p>Click <q>Add a Platform</q> and choose <q>iOS / MacOS</q></p></li>
<li><p>Enter your app&rsquo;s bundle ID and click <q>Configure</q> and then click <q>Done</q></p></li>
<li><p>In your code, set the Client ID into the <code><a href="Classes/BREReceiptManager.html#/c:objc(cs)BREReceiptManager(py)outlookClientId">BREReceiptManager.outlookClientId</a></code> property</p></li>
<li><p>Outlook uses OAuth to authenticate user accounts via a modal view controller provided by Microsoft&rsquo;s SDK. Here is how you invoke it from within your own view controller:</p></li>
</ul>
<pre class="highlight objective_c"><code><span class="p">[[</span><span class="n">BREReceiptManager</span> <span class="nf">shared</span><span class="p">]</span> <span class="nf">beginOAuthForProvider</span><span class="p">:</span><span class="n">BREReceiptProviderOutlook</span>
                               <span class="nf">withViewController</span><span class="p">:</span><span class="n">self</span>
                                    <span class="n">andCompletion</span><span class="o">:^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>

                                        <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
                                            <span class="c1">//Account successfully authenticated</span>
                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                            <span class="c1">//Failed to authenticate</span>
                                        <span class="p">}</span>
                                    <span class="p">}];</span>
</code></pre>

<ul>
<li>Add the following to your app delegate:</li>
</ul>
<pre class="highlight plaintext"><code>#import &lt;MSAL/MSAL.h&gt;
...
- (BOOL)application:(UIApplication *)app
            openURL:(NSURL *)url
            options:(NSDictionary *)options
{
    return [MSALPublicClientApplication handleMSALResponse:url
                                           sourceApplication:options[UIApplicationOpenURLOptionsSourceApplicationKey]];
}
</code></pre>

<ul>
<li><p>Add a URL handler for the scheme <code>msauth.[your_bundle_id]</code> to your app&rsquo;s <code>Info.plist</code> (or via the Target settings interface in XCode)</p></li>
<li><p>Add an array key to your app&rsquo;s <code>Info.plist</code> file called <code>LSApplicationQueriesSchemes</code> and add 2 string values to it: <code>msauthv2</code> and <code>msauthv3</code></p></li>
<li><p>Add a Keychain Group to your target (in your target&rsquo;s settings under Signing &amp; Capabilities -&gt; Keychain Sharing in XCode) named <code>com.microsoft.adalcache</code></p></li>
</ul>
<h2 id='yahoo-amp-aol-imap-integration' class='heading'>Yahoo &amp; AOL (IMAP Integration)</h2>

<p>Create your own UI for the user to enter their e-mail address and password, and set these values into the corresponding properties in the SDK. You can then verify the credentials are valid as in this example:</p>
<pre class="highlight objective_c"><code><span class="k">-</span> <span class="p">(</span><span class="n">IBAction</span><span class="p">)</span><span class="nf">btnOKTouched</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">sender</span> <span class="p">{</span>
    <span class="p">[[</span><span class="n">BREReceiptManager</span> <span class="nf">shared</span><span class="p">]</span> <span class="nf">storeImapCredentials</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">txtEmail</span><span class="p">.</span><span class="n">text</span>
                                     <span class="nf">andPassword</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">txtPassword</span><span class="p">.</span><span class="n">text</span>
                                     <span class="nl">forProvider:</span><span class="n">BREReceiptProviderAOL</span><span class="p">];</span>

    <span class="p">[[</span><span class="n">BREReceiptManager</span> <span class="nf">shared</span><span class="p">]</span> <span class="nf">verifyImapCredentials</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">BOOL</span> <span class="n">success</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//Credentials verified</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">//Failed to verify credentials</span>
        <span class="p">}</span>

    <span class="p">}];</span>

<span class="p">}</span>
</code></pre>
<h2 id='retrieving-and-parsing-e-receipts' class='heading'>Retrieving and Parsing E-Receipts</h2>

<p>Once you have successfully integrated one or more mail providers, and the user has successfully authenticated their account, you can begin retrieving and parsing e-receipts as follows:</p>
<pre class="highlight objective_c"><code><span class="p">[[</span><span class="n">BREReceiptManager</span> <span class="nf">shared</span><span class="p">]</span> <span class="nf">getEReceiptsWithCompletion</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="n">scanResults</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Found %lu new e-receipt orders"</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">scanResults</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Error retrieving e-receipts"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}];</span>
</code></pre>

<p>This will connect to the user&rsquo;s email account and search for new e-receipts from all supported retailers <em>since the most recent successful retrieval of e-receipts</em>.</p>

<p>If any orders are found, they will be returned as an array of <code>BRScanResults</code> objects. These objects contain many of the standard fields that are populated when scanning a physical receipt, but also contain certain properties that are unique to e-receipts such as:</p>

<ul>
<li><code>BRScanResults.ereceiptOrderNum</code></li>
<li><code>BRScanResults.ereceiptRawHTML</code></li>
</ul>

<p>The <code>BRScanResults.products</code> array is composed of <code>BRProduct</code> objects as usual, but with 1 additional property: <code>BRProduct.shippingStatus</code></p>

<p>Finally, you can control how far back to search in the user&rsquo;s email for e-receipts via the <code><a href="Classes/BREReceiptManager.html#/c:objc(cs)BREReceiptManager(py)dayCutoff">BREReceiptManager.dayCutoff</a></code> property. The default is 14 days.</p>

          </section>
        </section>
        <section id="footer">
          <p>&copy; 2020 <a class="link" href="https://www.blinkreceipt.com" target="_blank" rel="external">BlinkReceipt LLC</a>. All rights reserved. (Last updated: 2020-05-30)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.9.4</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
