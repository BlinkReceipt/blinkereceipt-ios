<!DOCTYPE html>
<html lang="en">
  <head>
    <title>E-Receipt Parsing  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    <style> table {border: thin solid black; border-spacing: 0px} td {border: thin solid black; padding: 5px} </style>
    <script src="js/lunr.min.js" defer></script>
    <script src="js/typeahead.jquery.js" defer></script>
    <script src="js/jazzy.search.js" defer></script>
  </head>
  <body>
    <a title="E-Receipt Parsing  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">BlinkEReceipt extension SDK 2.2.0 Docs</a></p>
        <p class="header-right"><a href="https://github.com/BlinkReceipt/blinkereceipt-ios"><img src="img/gh.png"/>View on GitHub</a></p>
        <p class="header-right">
          <form role="search" action="search.json">
            <input type="text" placeholder="Search documentation" data-typeahead>
          </form>
        </p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">BlinkEReceipt extension SDK Reference</a>
        <img id="carat" src="img/carat.png" />
        E-Receipt Parsing  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Guides.html">Guides</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="account-linking.html">Account Linking</a>
              </li>
              <li class="nav-group-task">
                <a href="e-receipt-parsing.html">E-Receipt Parsing</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/BRAccountLinkingCredentials.html">BRAccountLinkingCredentials</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/BRAccountLinkingManager.html">BRAccountLinkingManager</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/BREReceiptManager.html">BREReceiptManager</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Enums.html">Enumerations</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/BRAccountLinkingError.html">BRAccountLinkingError</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/BRAccountLinkingRetailer.html">BRAccountLinkingRetailer</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/BREReceiptIMAPError.html">BREReceiptIMAPError</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/BREReceiptProvider.html">BREReceiptProvider</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/BRSetupIMAPResult.html">BRSetupIMAPResult</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <h1 id='e-receipt-parsing' class='heading'>E-Receipt Parsing</h1>

<p>The BlinkReceipt SDK supports parsing e-receipts from a growing list of retailers and a specific set of mail providers: Gmail, Outlook, Yahoo, and AOL. The procedure for integrating each of these providers is slightly different. This guide will outline the steps necessary to integrate and authenticate a user account for each mail provider, and then the common methods that you will use to invoke the e-receipt parsing functionality.</p>
<h2 id='gmail' class='heading'>Gmail</h2>

<ul>
<li><p>Create a new Project in the <a href="https://console.developers.google.com">Google API Console</a></p></li>
<li><p>Enable the Gmail API for your project</p></li>
<li><p>Create new credentials for the API, and choose the iOS option. This should lead you through the process to create an OAuth 2.0 client ID. You will have to complete the setup of an OAuth Consent Screen.</p></li>
<li><p>Once you have successfully completed the process, find the Client ID for your app&rsquo;s bundle identifier</p></li>
</ul>

<p><img src="img/gmail.png" alt="Google API Console"></p>

<ul>
<li><p>Provide this Client ID via the <code><a href="Classes/BREReceiptManager.html#/c:objc(cs)BREReceiptManager(py)googleClientId">BREReceiptManager.googleClientId</a></code> property</p></li>
<li><p>Gmail uses OAuth to authenticate user accounts via a modal view controller provided by Google&rsquo;s SDK. Here is how you invoke it from within your own view controller:</p></li>
</ul>
<pre class="highlight objective_c"><code><span class="p">[[</span><span class="n">BREReceiptManager</span> <span class="nf">shared</span><span class="p">]</span> <span class="nf">beginOAuthForProvider</span><span class="p">:</span><span class="n">BREReceiptProviderGmail</span>
                               <span class="nf">withViewController</span><span class="p">:</span><span class="n">self</span>
                                    <span class="n">andCompletion</span><span class="o">:^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>

                                        <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
                                            <span class="c1">//Account successfully authenticated</span>
                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                            <span class="c1">//Failed to authenticate</span>
                                        <span class="p">}</span>
                                    <span class="p">}];</span>
</code></pre>

<ul>
<li>In order to handle the response from the OAuth process, you need to add the following to your app delegate:</li>
</ul>
<pre class="highlight plaintext"><code>#import &lt;BlinkEReceipt/BREReceiptManager.h&gt;
...
- (BOOL)application:(UIApplication *)app
            openURL:(NSURL *)url
            options:(NSDictionary *)options
{
    return [[BREReceiptManager shared] openURL:url
                                       options:options
                                       provider:BREReceiptProviderGmail];
}
</code></pre>

<ul>
<li>Lastly, follow <a href="https://developers.google.com/identity/sign-in/ios/start-integrating#add_a_url_scheme_to_your_project">Google&rsquo;s instructions</a> to add the necessary URL scheme to your app</li>
</ul>
<h2 id='outlook' class='heading'>Outlook</h2>

<ul>
<li><p>Go to the <a href="https://portal.azure.com/">Azure Portal</a>, choose Manage Azure Active Directory, then App Registrations from the left menu, and click New Registration.</p></li>
<li><p>Enter a name for your app, choose the option to support accounts in any Azure AD directory as well as personal Microsoft accounts, and choose &ldquo;Public client/native&rdquo; for the Redirect URI type. Don&rsquo;t worry about the field value. Click Register.</p></li>
<li><p>This will generate an Application (client) ID which you should note for later.</p></li>
</ul>

<p><img src="img/outlook.png" alt="MS Portal"></p>

<ul>
<li><p>Now click &ldquo;Add a Redirect URI&rdquo; on the right side</p></li>
<li><p>Click &ldquo;Add a Platform&rdquo; and choose &ldquo;iOS / MacOS&rdquo;</p></li>
<li><p>Enter your app&rsquo;s bundle ID and click &ldquo;Configure&rdquo; and then click &ldquo;Done&rdquo;</p></li>
<li><p>In your code, set the Client ID into the <code><a href="Classes/BREReceiptManager.html#/c:objc(cs)BREReceiptManager(py)outlookClientId">BREReceiptManager.outlookClientId</a></code> property</p></li>
<li><p>Outlook uses OAuth to authenticate user accounts via a modal view controller provided by Microsoft&rsquo;s SDK. Here is how you invoke it from within your own view controller:</p></li>
</ul>
<pre class="highlight objective_c"><code><span class="p">[[</span><span class="n">BREReceiptManager</span> <span class="nf">shared</span><span class="p">]</span> <span class="nf">beginOAuthForProvider</span><span class="p">:</span><span class="n">BREReceiptProviderOutlook</span>
                               <span class="nf">withViewController</span><span class="p">:</span><span class="n">self</span>
                                    <span class="n">andCompletion</span><span class="o">:^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>

                                        <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
                                            <span class="c1">//Account successfully authenticated</span>
                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                            <span class="c1">//Failed to authenticate</span>
                                        <span class="p">}</span>
                                    <span class="p">}];</span>
</code></pre>

<ul>
<li>Add the following to your app delegate:</li>
</ul>
<pre class="highlight plaintext"><code>#import &lt;BlinkEReceipt/BREReceiptManager.h&gt;
...
- (BOOL)application:(UIApplication *)app
            openURL:(NSURL *)url
            options:(NSDictionary *)options
{
    return [[BREReceiptManager shared] openURL:url
                                       options:options
                                       provider:BREReceiptProviderOutlook];
}
</code></pre>

<ul>
<li><p>Add a URL handler for the scheme <code>msauth.[your_bundle_id]</code> to your app&rsquo;s <code>Info.plist</code> (or via the Target settings interface in XCode)</p></li>
<li><p>Add an array key to your app&rsquo;s <code>Info.plist</code> file called <code>LSApplicationQueriesSchemes</code> and add 2 string values to it: <code>msauthv2</code> and <code>msauthv3</code></p></li>
<li><p>Add a Keychain Group to your target (in your target&rsquo;s settings under Signing &amp; Capabilities -&gt; Keychain Sharing in XCode) named <code>com.microsoft.adalcache</code></p></li>
</ul>
<h2 id='yahoo-aol-gmail-imap-integration' class='heading'>Yahoo, AOL, Gmail (IMAP Integration)</h2>

<p>In order to connect to Yahoo or AOL via IMAP, or to connect to Gmail via IMAP (if the SDK integration above is not possible), some additional setup is required in the user&rsquo;s respective email account:</p>

<ul>
<li><p>For Yahoo/AOL, a user must create an &ldquo;App Password&rdquo; (which is different than their regular account password). </p></li>
<li><p>For Gmail, there are 2 ways that a user can access their account through IMAP:</p>

<ol>
<li>If they have a special setting called &ldquo;Less Secure Apps&rdquo; enabled <strong>-OR-</strong></li>
<li>If they generate an &ldquo;Application Password&rdquo; and use that to authenticate</li>
</ol></li>
</ul>

<p>Our SDK attempts to automate this setup for all providers &ldquo;behind the scenes&rdquo;:</p>

<ul>
<li>Create your own UI to collect the user&rsquo;s email and regular account password, and set these values into the corresponding properties in the SDK:</li>
</ul>
<pre class="highlight objective_c"><code><span class="p">[[</span><span class="n">BREReceiptManager</span> <span class="nf">shared</span><span class="p">]</span> <span class="nf">storeImapCredentials</span><span class="p">:</span><span class="n">email</span>
                                     <span class="nf">andPassword</span><span class="p">:</span><span class="n">password</span>
                                     <span class="n">forProvider</span><span class="o">:</span><span class="n">BREReceiptProviderYahoo</span><span class="p">];</span>
</code></pre>

<ul>
<li>Then call the special IMAP setup method which will attempt to login to the user&rsquo;s account create an App Password (or in the case of Gmail, determine if Less Secure Apps is already enabled):</li>
</ul>
<pre class="highlight objective_c"><code><span class="p">[[</span><span class="n">BREReceiptManager</span> <span class="nf">shared</span><span class="p">]</span> <span class="nf">setupIMAPForProvider</span><span class="p">:</span><span class="n">BREReceiptProviderYahoo</span>
                                  <span class="nf">viewController</span><span class="p">:</span><span class="n">self</span>
                                  <span class="n">withCompletion</span><span class="o">:^</span><span class="p">(</span><span class="n">BRSetupIMAPResult</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">BRSetupIMAPResultCreatedAppPassword</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Successfully created app password."</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">BRSetupIMAPResultEnabledLSA</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Successfully enabled Gmail Less Secure Apps."</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}];</span>
</code></pre>

<ul>
<li>If this succeeds, you can then verify the connection to the IMAP server:</li>
</ul>
<pre class="highlight objective_c"><code><span class="p">[[</span><span class="n">BREReceiptManager</span> <span class="nf">shared</span><span class="p">]</span> <span class="nf">verifyImapCredentials</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">BOOL</span> <span class="n">success</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//Credentials verified</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">//Failed to verify credentials</span>
    <span class="p">}</span>

<span class="p">}];</span>
</code></pre>
<h2 id='custom-imap-server-integration' class='heading'>Custom IMAP server integration</h2>

<p>If you would like to connect to an email provider through IMAP other than the ones supported out of the box, you may do so by setting the IMAP server details <em>before</em> you store credentials, which is then passed the special <code>BREReceiptProviderCustomIMAP</code> value:</p>
<pre class="highlight objective_c"><code><span class="n">NSString</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="s">@"imap.myserver.com"</span><span class="p">;</span>
<span class="n">NSInteger</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">993</span><span class="p">;</span>
<span class="n">BOOL</span> <span class="n">useTLS</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>

<span class="p">[[</span><span class="n">BREReceiptManager</span> <span class="nf">shared</span><span class="p">]</span> <span class="nf">setCustomIMAPHost</span><span class="p">:</span><span class="n">host</span> <span class="nf">port</span><span class="p">:</span><span class="n">port</span> <span class="n">useTLS</span><span class="o">:</span><span class="n">useTLS</span><span class="p">];</span>

<span class="p">[[</span><span class="n">BREReceiptManager</span> <span class="nf">shared</span><span class="p">]</span> <span class="nf">storeImapCredentials</span><span class="p">:</span><span class="n">email</span> <span class="nf">andPassword</span><span class="p">:</span><span class="n">pass</span> <span class="n">forProvider</span><span class="o">:</span><span class="n">BREReceiptProviderCustomIMAP</span><span class="p">];</span>
</code></pre>

<blockquote>
<p>Note: For a custom IMAP server, you do not need to (and should not) call <code>setupIMAPForProvider:viewController:withCompletion:</code></p>
</blockquote>
<h2 id='retrieving-and-parsing-e-receipts' class='heading'>Retrieving and Parsing E-Receipts</h2>

<p>Once you have successfully integrated one or more mail providers, and the user has successfully authenticated their account, you can begin retrieving and parsing e-receipts as follows:</p>
<pre class="highlight objective_c"><code><span class="p">[[</span><span class="n">BREReceiptManager</span> <span class="nf">shared</span><span class="p">]</span> <span class="nf">getEReceiptsWithCompletion</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="n">scanResults</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Found %lu new e-receipt orders"</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">scanResults</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Error retrieving e-receipts"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}];</span>
</code></pre>

<p>This will connect to the user&rsquo;s email account and search for new e-receipts from all supported retailers <em>since the most recent successful retrieval of e-receipts</em>.</p>

<p>If any orders are found, they will be returned as an array of <code>BRScanResults</code> objects. These objects contain many of the standard fields that are populated when scanning a physical receipt, but also contain certain properties that are unique to e-receipts such as:</p>

<ul>
<li><code>BRScanResults.ereceiptOrderNum</code></li>
<li><code>BRScanResults.ereceiptRawHTML</code></li>
</ul>

<p>The <code>BRScanResults.products</code> array is composed of <code>BRProduct</code> objects as usual, but with 1 additional property: <code>BRProduct.shippingStatus</code></p>

<p>Finally, you can control how far back to search in the user&rsquo;s email for e-receipts via the <code><a href="Classes/BREReceiptManager.html#/c:objc(cs)BREReceiptManager(py)dayCutoff">BREReceiptManager.dayCutoff</a></code> property. The default is 14 days.</p>

          </section>
        </section>
        <section id="footer">
          <p>&copy; 2020 <a class="link" href="https://www.blinkreceipt.com" target="_blank" rel="external">BlinkReceipt LLC</a>. All rights reserved. (Last updated: 2020-10-16)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.13.5</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
